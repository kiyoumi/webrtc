<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录系统</title>
    <link rel="stylesheet" href="public/css/reset.css">
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="public/css/common.css">
    <link rel="stylesheet" href="public/css/iconfont.css">
    <link rel="stylesheet" href="public/css/login.css">
</head>
<body>
<div class="main">
    <form id="loginBlock" class="layui-form sun-form" action="">
        <div class="sun-form-item">
            <div class="sun-input-block">
                <input id="loginPhone" type="text" name="account" autocomplete="off" placeholder="OA帐号/手机号" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block">
                <input id="loginPass" type="password" name="pass" lay-verify="pass" placeholder="密码" autocomplete="off" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item" style="font-size:14px;margin-bottom:5px;">
            <div class="fl" style="margin-right:30px;">
                <div class="formCheckbox formCheckboxInput">
                    <input id="rememberPass" type="checkbox" onchange="changeRem()">
                </div>
                <div class="formCheckbox">记住密码</div>
            </div>
            <div class="fl">
                <div  class="formCheckbox formCheckboxInput">
                    <input id="automaticLogin" type="checkbox" onchange="change()">
                </div>
                <div class="formCheckbox">自动登录</div>
            </div>
            <div class="fr" style="margin-right:10px;">
                <a id="toSetPass" class="m-l-ms p-xs sun-cl-blue">忘记密码？</a>
            </div>
        </div>
        <div class="sun-form-item" style="margin-top:15px;">
            <div class="sun-input-block">
                <button id="loginButton" class="sun-btn" lay-submit="" lay-filter="login" style="width:100%;">
                    <img class="loadingImg displayNone" src="public/images/loading.jpg" alt="">
                    <span class="">登录</span>
                </button>
                <a id="toRegButton" class="sun-inline m-l-ms p-xs sun-cl-blue fr">立即注册</a>
            </div>
        </div>
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block other-login">
                <div style="float: left;">第三方登录：</div>
                <div>
                    <a id="QQButton" title="QQ登录">
                        <i class="iconfont icon-qq-copy"></i>
                    </a>
                    <a id="wechatButton" title="微信登录">
                        <i class="iconfont icon-weixin-color"></i>
                    </a>
                </div>
            </div>
        </div>
    </form>
    <form id="registerBlock" class="layui-form sun-form displayNone" action="">
        <div class="sun-form-item">
            <div class="sun-input-block">
                <input type="text" name="name" lay-verify="required" autocomplete="off" placeholder="昵称" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block">
                <input id="regPhone" onblur="blurInput()" name="account" lay-verify="required" placeholder="帐号/手机号" autocomplete="off" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item">
            <div>
                <input type="tel" name="verify" autocomplete="off" class="sun-input" placeholder="验证码" style="width:65%;display:inline-block">
                <div class="getPin sun-btn sun-btn-primary" type="register" style="width:30%;margin-bottom:1px">获取验证码</div>
            </div>
        </div>
        <div class="sun-form-item">
            <div class="sun-input-block">
                <input id="regPass" type="password" name="pass" lay-verify="pass" autocomplete="off" placeholder="设置密码" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block">
                <input id="_regPass" type="password" name="confirmPass" lay-verify="pass" placeholder="确认密码" autocomplete="off" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item">
            <div class="sun-input-block">
                <button id="registerButton" class="sun-btn" lay-submit="" lay-filter="register" style="width:100%;">
                    <img class="loadingImg displayNone" src="public/images/loading.jpg" alt="">
                    <span class="">注册</span>
                </button>
                <a class="toLoginButton sun-inline m-l-ms p-xs sun-cl-blue fr">已有账号，去登录</a>
            </div>
        </div>
    </form>
    <form id="rePasswordBlock" class="layui-form sun-form displayNone" action="">
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block">
                <input name="phone" lay-verify="phone" placeholder="手机号" autocomplete="off" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item">
            <div>
                <input type="tel" name="verify" lay-verify="required" autocomplete="off" class="sun-input" placeholder="验证码" style="width:60%;display:inline-block">
                <div class="getPin sun-btn sun-btn-primary" type="rePass" style="font-size:13px;">获取验证码</div>
            </div>
        </div>
        <div class="sun-form-item">
            <div class="sun-input-block">
                <input id="findPass" type="password" name="pass" lay-verify="pass" autocomplete="off" placeholder="设置密码" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item" style="margin-bottom:10px;">
            <div class="sun-input-block">
                <input  id="_findPass" type="password" name="confirmPass" lay-verify="pass" placeholder="确认密码" autocomplete="off" class="sun-input">
            </div>
        </div>
        <div class="sun-form-item">
            <div class="sun-input-block">
                <button id="findPassButton" class="sun-btn" lay-submit="" lay-filter="findPass" style="width:100%;">
                    <img class="loadingImg displayNone" src="public/images/loading.jpg" alt="">
                    <span>找回密码</span>
                </button>
                <a class="toLoginButton sun-inline m-l-ms p-xs sun-cl-blue fr">已有账号，去登录</a>
            </div>
        </div>
    </form>
</div>
</body>
<script type="text/javascript" src="public/js/util.js?t=0.01"></script>
<script type="text/javascript" src="public/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="layui/layui.js"></script>
<script type="text/javascript" src="public/js/jquery.base64.js"></script>
<script>
    layui.use('form', function(){
        var form=layui.form();

        //自定义验证规则
        form.verify({
            pass: [/^.{6,16}$/, '密码必须6到16位']
        });

        //监听提交
        form.on('submit(login)', function(data){
            $("#loginButton").attr("disabled","disabled");
            var loginInfo=data.field;
            var account=loginInfo.account.replace(/^\s+|\s+$/g,'');
            var passw=loginInfo.pass;
            if(account == ''){
                infoTips("不能为空",5);
                $("#loginPhone").addClass("layui-form-danger").focus();
            }else if(passw == ''){
                infoTips("不能为空",5);
                $("#loginPass").addClass("layui-form-danger").focus();
            }
            console.log(parent.loginFlag);
            if(parent.loginFlag){
                window.setTimeout(function(){
                    login(account,passw,0);
                },500);
                parent.loginFlag=false;
                return false;
            }else {
                $("#loginButton").attr("disabled",false);
            }
        });


        form.on('submit(findPass)', function(data){
            var findPassInfo=data.field;
            var phone=findPassInfo.phone.replace(/^\s+|\s+$/g,'');
            var pass=findPassInfo.pass;
            var verifyCode=findPassInfo.verify.replace(/^\s+|\s+$/g,'');
            var mm=$('#findPass').val();
            var nn=$("#_findPass").val();
            console.log(verifyCode.match(/\s+/g));
            if(verifyCode.length == 0 || verifyCode.match(/\s+/g)){
                if(verifyCode.length == 0){
                    infoTips("请输入验证码",5);
                }else{
                    infoTips("不能带空格",5);
                }
                $("input.sun-input[name='verify']").addClass("layui-form-danger").focus();
            }else if(mm.length==0){
                infoTips("请输入密码",5);
                $("#findPass").addClass("layui-form-danger").focus();
            }else if(mm.length>16 || mm.length<6){
                infoTips("密码必须6到16位",5);
                $("#findPass").addClass("layui-form-danger").focus();
            }else if(nn.length==0){
                infoTips("请再次输入密码",5);
                $("#_findPass").addClass("layui-form-danger").focus();
            }else if(mm !== nn){
                infoTips("两次密码不一样",5);
                $("#_findPass").addClass("layui-form-danger").focus();
            }else{
                findPass(phone,pass,verifyCode);
            }
            return false;
        });

        form.on('submit(register)', function(data){
            var registerInfo=data.field;
            var name=registerInfo.name.replace(/^\s+|\s+$/g,'');
            var phone=registerInfo.account.replace(/^\s+|\s+$/g,'');
            var pass=registerInfo.pass;
            var photo='';
            var verifyCode=registerInfo.verify.replace(/^\s+|\s+$/g,'');
            var mm=$('#regPass').val();
            var nn=$("#_regPass").val();
            var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/,type;
            if(name.length==0){
                infoTips("请输入昵称",5);
                $("#registerBlock input.sun-input[name='name']").addClass("layui-form-danger").focus();
                return false;
            }if (reg.test(phone)) {
                type=1;
                if(verifyCode.length == 0 || verifyCode.match(/\s+/g)){
                    if(verifyCode.length == 0){
                        infoTips("请输入验证码",5);
                    }else{
                        infoTips("不能带空格",5);
                    }
                    $("input.sun-input[name='verify']").addClass("layui-form-danger").focus();
                    return false;
                }
            }else{
                type=2;
                verifyCode='';
            }
            if(mm.length==0){
                infoTips("请输入密码",5);
                $("#findPass").addClass("layui-form-danger").focus();
                return false;
            }if(mm.length>16 || mm.length<6){
                infoTips("密码必须6到16位",5);
                $("#findPass").addClass("layui-form-danger").focus();
                return false;
            }if(nn.length==0){
                infoTips("请再次输入密码",5);
                $("#_findPass").addClass("layui-form-danger").focus();
                return false;
            }if(mm !== nn){
                infoTips("两次密码不一样",5);
                $("#_regPass").addClass("layui-form-danger").focus();
				return false;
            }else{
                register(name,phone,pass,photo,type,verifyCode);
            }
            return false;
        });
    });

 	function toLogin(){
        parent.$(".layui-layer,iframe").css("height","340px");
        parent.$(".layui-layer-title").html("登录");
        $("#loginBlock").removeClass("displayNone");
        $("#registerBlock,#rePasswordBlock").addClass("displayNone");
    }
    function toReg(){
        $('#registerBlock input').val('');
        $("input.sun-input[name='verify']").parent().parent().removeClass("displayNone");
        parent.$(".layui-layer,iframe").css("height","420px");
        parent.$(".layui-layer-title").html("注册");
        $("#loginBlock,#rePasswordBlock").addClass("displayNone");
        $("#registerBlock").removeClass("displayNone");
    }
    function blurInput() {
        var idstr = $('#regPhone').val();
        var type;
        var m = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        if (idstr === '') {
            parent.layer.msg("请输入帐号");
        } else {
            if (m.test(idstr)) {
                type = 1;
                $("input.sun-input[name='verify']").parent().parent().removeClass("displayNone");
                parent.$(".layui-layer").css("height", "420px");
                parent.$("iframe").css("height", "420px");
            } else {
                type = 2;
                $("input.sun-input[name='verify']").parent().parent().addClass("displayNone");
                parent.$(".layui-layer").css("height", "365px");
                parent.$("iframe").css("height", "365px");
            }
            $.ajax({
                type: 'GET',
                url: parent.host + 'apis/user/open/check',//发送请求
                data: {type: type, mapid: idstr},
                success: function (result) {
                    console.log("========检测是否帐号已注册=========");
                    console.log(result);
                    if (result.code === 0) {
                    } else {
                        parent.layer.msg("该帐号已注册！");
                    }
                }
            })
        }
    }

    function toSetPass(){
        $('#rePasswordBlock input').val('');
        parent.$(".layui-layer,iframe").css("height","370px");
        parent.$(".layui-layer-title").html("找回密码");
        $("#rePasswordBlock").removeClass("displayNone");
        $("#loginBlock,#registerBlock").addClass("displayNone");
    }

    $("#toRegButton").click(function(){
        toReg();
    });

    $(".toLoginButton").click(function(){
        toLogin();
        $(".toLoginButton").on("mouseover mouseout",function(event){
            if(event.type === "mouseover"){
                $(".toLoginButton").css("color","#777");
            }else if(event.type === "mouseout"){
                $(".toLoginButton").css("color","#1E9FFF");
            }
        })
    });

    $("#toSetPass").click(function(){
        toSetPass();
    });

    //记住密码，自动登录
    var userSaveInfo,savePhone,savePass;
    if(localStorage.getItem("userSaveInfo")){
        userSaveInfo=JSON.parse(localStorage.getItem('userSaveInfo'));
        savePhone=userSaveInfo.phone;
        savePass=userSaveInfo.password;
    }
    if(userSaveInfo){
        $('#loginPhone').val(savePhone);
        if(userSaveInfo.rememberPass){
            $("#rememberPass").attr("checked","checked");
            $('#loginPass').val(savePass);
        }else{
            $('#loginPass').val("");
        }
        if(userSaveInfo.automaticLogin){
            $("#automaticLogin").attr("checked","checked");
            $("#rememberPass").attr("checked","checked");
            $('#loginPass').val(savePass);
            window.setTimeout(function(){
                if(parent.loginFlag){
                    window.setTimeout(function(){
                        login(savePhone,savePass,0);
                    },500);
                    parent.loginFlag=false;
                    return false;
                }
            },1000);
        }
        parent.document.onkeydown=function(e){
            if (!e) e = window.event;
            if ((e.keyCode || e.which) === 13) {
                console.log(parent.loginFlag);
                if(parent.loginFlag){
                    window.setTimeout(function(){
                        login(savePhone,savePass,0);
                    },500);
                    parent.loginFlag=false;
                    return false;
                }
            }
        }
    }


    //login
    function login(account,passw,flagtype){
        $("#loginButton span").toggleClass("displayNone");
        $("#loginButton img").toggleClass("displayNone");
        parent.ownPhone = account;
        parent.ownPass = passw;
        var type;
        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        if (reg.test(account)) {
            type=1;
        }else{type=2;}
        $.ajax({
            type: 'POST',
            url: parent.host+'apis/user/open/login',
            data: {type:type,mapid:account,passwd:passw,nickname:'',photo:''},
            success: function(result) {
                console.log(result);
                var data = result;
                if(data.code === 0){
                    sessionStorage.setItem("token",data.result);
                    var payload=JSON.parse(decodeBase64(data.result.toString().split(".")[1]));
                    parent.LOGINFlag=true;
                    var user = {
                        phone:account,
                        uin:payload.uin,
                        automaticLogin:false,
                        rememberPass:false
                    };
                    parent.ownUin=payload.uin;
                    parent.clientId=payload.uin;
                    //保存token至有效期
                    document.cookie ="token="+ data.result + ";expires=" + new Date(payload.exp*1000);
                    //保存password 8分钟
                    document.cookie ="password="+ passw;
                    if($('#rememberPass').is(":checked")){//保存密码
                        user.password=passw;
                        user.rememberPass=true;
                    }
                    if($('#automaticLogin').is(":checked")){//自动登录标识
                        user.automaticLogin=true;
                        user.password=passw;
                    }
                    infoTips("登录成功",6,500);
                    parent.localAccount=account;
                    $("#loginButton span").toggleClass("displayNone");
                    $("#loginButton img").toggleClass("displayNone");
                    localStorage.setItem("userSaveInfo",JSON.stringify(user));
                    if(data.result.mobile){
                        parent.localPhone = data.result.mobile ;
                    }
                    window.setTimeout(function(){
                        parent.$("#extendedToolbar").removeClass("displayNone");
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index);
                    },500);
                }else{
                    parent.loginFlag=true;
                    infoTips(data.msg,5);
                    $("#loginButton span").toggleClass("displayNone");
                    $("#loginButton img").toggleClass("displayNone");
                    $("#loginButton").attr("disabled",false);
                }
            }
        })
    }

    //register
    function register(name,phone,passWord,photo,type,pin){
        $("#registerButton span").toggleClass("displayNone");
        $("#registerButton img").toggleClass("displayNone");
        parent.$.ajax({
            type: 'POST',
            url: parent.host+'apis/user/open/register',//发送请求
            data: {type:type,mapid:phone,passwd:passWord,nickname:name,photo:photo,sex:0,vcode:pin},
            dataType : "json",
            success: function(result) {
                console.log("=====用户注册=====");
                console.log(result);
                if(result.code === 0){
                    $("#registerButton span").toggleClass("displayNone");
                    $("#registerButton img").toggleClass("displayNone");
                    infoTips('注册成功',6,2000);
                    window.setTimeout(function(){
                        toLogin();
                        $('#registerBlock input').val('');
                    },1500);
                }else{
                    $("#registerButton span").toggleClass("displayNone");
                    $("#registerButton img").toggleClass("displayNone");
                    infoTips(data.msg,5);
                }
            }
        })
    }

    //find pass
    function findPass(phone,password,pin){
        $("#findPassButton span").toggleClass("displayNone");
        $("#findPassButton img").toggleClass("displayNone");
        $.ajax({
            type: 'GET',
            url: parent.host+'apis/user/open/password/reset',
            data: {type:type,mapid:phone,vcode:pin,passwd:password},
            async:false,
            dataType : "json",
            success: function(result) {
                console.log("=====重设密码=====");
                console.log(result);
                var data = result;
                if(data.code === 0){
                    $("#findPassButton span").toggleClass("displayNone");
                    $("#findPassButton img").toggleClass("displayNone");
                    infoTips('重设密码成功', 6, 2000);
                    window.setTimeout(function () {
                        toLogin();
                        $('#loginBlock input').val('');
                    }, 1500);
                }else{
                    $("#findPassButton span").toggleClass("displayNone");
                    $("#findPassButton img").toggleClass("displayNone");
                    infoTips(data.msg, 5, 2000);
                }
            }
        })
    }


    //获取验证码
    $('.getPin').click(function () {
        var index,type;
        if($(this).attr("type") === "register"){
            index=0;
        }else{
            index=1;
        }
        type=index+1;
        console.log($(this).parent().parent().siblings().find("input[name='account']").val());
        var phone=$(this).parent().parent().siblings().find("input[name='account']").val().replace(/^\s+|\s+$/g,'');
        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        if (reg.test(phone)) {
            pin(phone,type,$('.getPin')[index]);
        }else{
            infoTips("请输入正确的手机号码",5);
        }
    });
    
    $("#QQButton").unbind("click").bind("click",function () {
        console.log("QQButton");
        $.get(parent.host+"apis/user/open/getQqAuthUrl",function(data){
            console.log("data");
            //window.location.href=data.result;
            if(data.code===0){
                window.open(data.result.qqAuthUrl);
            }else{
                infoTips(data.msg,5);
            }

        });
    })

    $("#wechatButton").unbind("click").bind("click",function () {
        console.log("wechatButton");
        $.get(parent.host+"apis/user/open/getWechatAuthUrl",function(data){
            console.log("data");
            if(data.code===0){
                window.open(data.result.wechatAuthUrl);
            }else{
                infoTips(data.msg,5);
            }

        });
    })
    
    
    //get message authentication code
    // type:1-------用户注册验证码，type:2-------重设密码验证码
    function pin(phone,type,target){
        $.ajax({
            type: 'GET',
            url: parent.host+'apis/user/open/vcode/get',//发送请求
            data: {type:type,mobile:phone},
            async:false,
            dataType : "json",
            success: function(result) {
                console.log("========获取短信验证码=========");
                console.log(result);
                if(result.code === 0){
                    setTime(target);
                }else{
                    infoTips(data.msg,5);
                }
            }
        })
    }


    //60s cut down
    var countdown =60;
    var setTime=function(target){
        var _timer =setTimeout(function() {
            setTime(target)
        },1000);
        if (countdown === 0) {
            target.innerHTML ='获取验证码';
            countdown = 60;
            clearTimeout(_timer);
        } else {
            target.innerHTML ="重新发送(" + countdown + ")";
            countdown--;
        }
    };


    function change(){
        if($("#automaticLogin").attr("checked")==="checked"){
            $("#rememberPass").attr("checked","checked");
        }
    }
    function changeRem(){
        if($("#rememberPass").attr("checked")!=="checked"){
            $("#automaticLogin").attr("checked",false);
        }
    }
</script>
</html>